# Feature Specification: NightLoom MVP診断体験

**Feature Branch**: `001-initial-plan`  
**Created**: 2025-10-14  
**Status**: Draft  
**Input**: NightLoomのMVP診断体験 — 4シーン構成の分岐型ストーリープレイを通じて動的な評価軸とタイプ分類を生成し、結果画面まで一貫したセッションを提供する機能セット。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 初回アクセスで診断を開始する (Priority: P1)

来訪ユーザーが NightLoom を開き、提示された初期キーワード候補または任意入力を用いて診断セッションを開始できる。

**Why this priority**: 診断体験の入口として最重要。セッションを開始できなければ以降の価値を提供できない。

**Independent Test**: 新規ユーザーがトップ画面からセッションを開始し、初期単語を選択すると最初のシーンが表示されることを確認すれば価値が成立する。

**Acceptance Scenarios**:

1. **Given** 新規訪問者、**When** 「診断を始める」を選択、**Then** セッションID・初期文字・候補単語が提示される
2. **Given** 候補単語、**When** 任意選択または自由入力で確定、**Then** シーン1のストーリーと選択肢が提示される
3. **Given** LLMの初期生成失敗、**When** セッション開始、**Then** 既定の2軸と固定シナリオで診断が継続される

---

### User Story 2 - 4シーンの選択体験を完走する (Priority: P2)

ユーザーが各シーンで選択を行い、セッションステータス遷移とスコア集計が正しく進む。

**Why this priority**: 行動選択を通じて性格傾向を観測するコア価値であり、全シーンの完走が必要。

**Independent Test**: 任意のシーンで選択を行い、次シーンが表示され、内部でスコアが蓄積されることを確認できれば価値が成立する。

**Acceptance Scenarios**:

1. **Given** シーンnが表示、**When** 1つの選択肢を確定、**Then** シーンn+1がロードされ進行状況が更新される
2. **Given** ネットワーク遅延、**When** 次シーン取得、**Then** ローディング表示とタイムアウト後のリトライ導線が表示される
3. **Given** LLMシーン生成失敗、**When** 次シーンを要求、**Then** 固定シナリオがシームレスに表示される

---

### User Story 3 - 結果と学びを受け取り次アクションへ進む (Priority: P3)

ユーザーが集計結果（評価軸・タイプ・キーワード）を理解し、再診断などの行動を選択できる。

**Why this priority**: 診断体験のゴールであり、ユーザーが自己理解と再挑戦の動機を得るために不可欠。

**Independent Test**: 4シーン完了後に結果画面へ遷移し、タイプ説明と評価軸スコアが表示され、「もう一度診断する」が機能すれば価値が成立する。

**Acceptance Scenarios**:

1. **Given** セッション完了、**When** 結果画面表示、**Then** タイプ名・説明・キーワード・2〜6評価軸スコアが全て表示される
2. **Given** 結果表示中、**When** 「もう一度診断する」を選択、**Then** 新セッションが発行され履歴が置き換わる
3. **Given** タイプ生成で閾値判定が揺らぐ、**When** 結果生成、**Then** 再試行またはプリセットタイプが用意され結果が欠落しない

---

### Edge Cases

- ネットワークタイムアウトやLLM API障害時にフォールバック資材へ切り替えてセッションを継続できるか
- 軸数が2未満または6超過となった場合に自動的に既定軸へ縮退できるか
- 同一ユーザーがブラウザバックで古いセッションIDを利用した際に不正アクセスとしてエラー誘導できるか
- 選択肢未入力・自由入力のバリデーション（禁止語・文字数制限）違反時に再入力を促せるか
- シーン途中でセッションが終了した際に再開ではなく新規セッションを案内できるか
- モバイル（360px幅想定）およびデスクトップでレスポンシブにUIが崩れないか
- `prefers-reduced-motion` ユーザー向けにアニメーションを抑制できるか
- LLM応答遅延により結果生成が5s超過した場合にローディングと遅延メッセージを提示できるか

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは初回アクセス時にセッションID、初期文字、候補単語を含むブートストラップ結果を返さなければならない。
- **FR-002**: システムはユーザーが候補選択または自由入力でキーワードを確定した際にセッションを`PLAY`状態へ遷移させ、シーン1を返さなければならない。
- **FR-003**: システムは各シーンでユーザーの選択結果を受け取り、重みベクトルを累積して内部スコアを更新しなければならない。
- **FR-004**: システムは4シーン完了後に評価軸スコアを0〜100へ正規化し、結果生成APIで返却しなければならない。
- **FR-005**: システムはセッションごとに2〜6軸を動的生成し、名称・説明・方向性を結果表示で利用できる形で提供しなければならない。
- **FR-006**: システムは2軸の主軸を選定し、4〜6種類のタイプ名・説明・キーワードを返却してユーザーに提示しなければならない。
- **FR-007**: システムはLLM応答失敗時に再試行し、それでも失敗した場合は既定の軸・シナリオ・タイプを用いたフォールバックを即時適用しなければならない。
- **FR-008**: システムはセッション内データをメモリ（または同等の一時領域）に限定し、結果表示後は永続化せずに破棄しなければならない。
  - **セッション自動破棄**: 結果表示後30秒で自動削除、非アクティブセッション10分でタイムアウト
  - **データ完全削除**: メモリ参照切断、一時ファイル削除、ガベージコレクション実行
  - **永続化防止機構**: データベース書き込み禁止、ファイルシステム保存阻止、外部ストレージ連携なし
- **FR-009**: システムはUX向上のため、各シーン取得中と結果生成中にローディング状態と失敗時の再試行導線を表示しなければならない。
- **FR-010**: システムは結果画面でAR IAラベルやキーボードフォーカス順を定義し、スクリーンリーダー利用者が主要情報を把握できるようにしなければならない。
- **FR-011**: システムは各セッションで発生したフォールバック種別・レイテンシ・エラーコードを観測ログとして記録しなければならない。
- **FR-012**: システムは「もう一度診断する」操作時に新しいセッションIDを払い出し、ブラウザ履歴を置き換えて戻る操作で旧結果が表示されないようにしなければならない。

### Non-Functional Requirements

- **NFR-001**: システムは同時稼働セッション10件で95%のリクエストを800ms以内で処理しなければならない。
- **NFR-002**: システムは99.5%の可用性を維持し、計画メンテナンス以外のダウンタイムを月間3.6時間以内に抑制しなければならない。
- **NFR-003**: システムはモバイル（360px以上）からデスクトップまでレスポンシブ対応し、全デバイスで機能崩れなく動作しなければならない。
- **NFR-004**: システムは`prefers-reduced-motion`設定を尊重し、アクセシビリティガイドラインの基本項目に準拠しなければならない。
- **NFR-005**: システムはセッションデータをメモリ限定で管理し、結果表示後は確実にデータを破棄しなければならない。
  - **メモリクリーンアップ**: WeakRef活用による自動参照削除、定期ガベージコレクション
  - **セッション漏洩監視**: アクティブセッション数監視、メモリ使用量アラート、異常検知
  - **プライバシー保護**: セッション間データ漏洩防止、ブラウザキャッシュ無効化、履歴痕跡除去
- **NFR-006**: システムは全APIエンドポイントで入力データ検証（文字数制限、形式検証、SQLインジェクション防止）を実装し、不正入力を即座に拒否しなければならない。
  - **検証項目**: キーワード入力は100文字以内、英数字と一般的な記号のみ許可
  - **セッションID**: UUIDv4形式の厳密検証
  - **選択肢インデックス**: 0-3の範囲内整数値のみ受付
- **NFR-007**: システムはIP別・セッション別のレート制限を実装し、DDoS攻撃や過度なAPI利用を防御しなければならない。
  - **IP別制限**: 1分間に30リクエスト、1時間に200リクエスト
  - **セッション別制限**: 1セッション内で各APIエンドポイント最大10回まで
  - **超過時対応**: 429ステータスコードとRetry-Afterヘッダーを返却
- **NFR-008**: システムはセッション情報とログデータを適切に保護し、機密情報の漏洩を防止しなければならない。
  - **セッション暗号化**: セッションデータはメモリ内でAES-256暗号化
  - **ログマスキング**: ユーザー入力キーワードは部分マスキング（最初の2文字のみ表示）
  - **個人識別情報**: IPアドレスはハッシュ化後にログ保存
- **NFR-009**: システムはセキュリティエラー時に詳細情報を開示せず、一般的なエラーメッセージを返却しなければならない。
  - **認証エラー**: 「セッションが無効です」で統一
  - **バリデーションエラー**: 「入力内容を確認してください」で統一
  - **内部エラー**: 「一時的な問題が発生しました」で統一し、詳細はサーバーログのみに記録

### Key Entities *(include if feature involves data)*

- **Session**: 診断フロー全体を束ねる一時的な識別子。状態（INIT / PLAY / RESULT）と選択履歴、フォールバック有無を保持する。
- **Scene**: 各シーンのストーリーテキストと4つの選択肢。テーマIDと軸重みベクトルを含み、順次取得される。
- **Choice**: 1つの選択肢。表示テキストと軸ごとの重み、選択済みフラグを持つ。
- **AxisScore**: 2〜6軸の名称、方向性ラベル、正規化スコア。結果画面とタイプ判定に利用。
- **TypeProfile**: 主軸2本から導出されたタイプ名称・説明・キーワード・極性タグ。4〜6種生成。
- **ThemeDescriptor**: 各セッションに紐づくUIテーマIDと関連メタ。画面全体のビジュアルを統一する。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 95%のセッションで初回アクセスから結果表示までの所要時間が4.5秒以内で完了する。
- **SC-002**: 99%のセッションでフォールバックを含め必ず結果が生成され、ユーザーが未完了で離脱しない。
- **SC-003**: 90%のユーザーが結果画面で提示されたタイプ説明を理解したと回答する。

  **測定方法**:
  - **対象ユーザー群**:
    - サンプルサイズ: 最低30名（統計的有意性確保のため）
    - 属性: 性格診断ツール未経験者50%、経験者50%の混合
    - 年齢層: 20〜40代を中心とした一般ユーザー
  
  - **理解度測定指標**:
    - **主指標**: タスク完了後の理解度確認質問（5段階評価）で4以上を「理解した」と定義
    - **補助指標1**: タイプ説明の要約タスクで主要特徴を正しく説明できる率
    - **補助指標2**: 結果画面での滞在時間が30秒以上（十分な読み取り時間の確保）
  
  - **測定手法**:
    - **ユーザビリティテスト**: 診断完了後の構造化インタビュー
    - **理解度確認質問**: 「あなたのタイプ説明をどの程度理解できましたか？」（1:全く理解できない〜5:完全に理解できた）
    - **要約タスク**: 「あなたのタイプの特徴を簡潔に説明してください」（キーワード的中率で評価）
  
  - **成功判定基準**:
    - 理解度確認質問で4-5評価が全体の90%以上
    - 要約タスクでタイプの主要特徴（キーワード・極性）を70%以上正確に言及
    - 両基準を満たした場合にSC-003達成とする
- **SC-004**: 80%のユーザーが「もう一度診断する」導線または共有アクションに到達し、体験継続意欲を示す。
- **SC-005**: シーン表示および結果表示のp95レイテンシがそれぞれ800ms・1.2s以内である。

### C004 Performance Measurement Compliance
**憲章準拠**: Performance Guarantees原則 - p95 < 2s実装保証

#### p95レイテンシ計測実装方法
- **計測ポイント**:
  - Request開始～Response完了までの全経路時間
  - LLM呼び出し時間（成功/フォールバック別）
  - フロントエンド描画完了時間（LCP基準）
- **メトリクス収集**:
  - リアルタイムHistogram収集（1分間隔でp95算出）
  - セッション単位の累積レイテンシ追跡
  - エンドポイント別性能分析データ
- **監視体制**:
  - 2s超過時の即座アラート発動
  - 性能劣化トレンド検知（15分間隔）
  - フォールバック発動率とレイテンシ相関監視

#### 技術実装仕様
```python
# Backend: observability.py
- PerformanceMiddleware: 全HTTPリクエストの計測
- MetricsCollector: p95計算とアラート判定
- HealthChecker: 性能劣化の自動検知
```

```typescript
// Frontend: performance.ts
- WebVitalsTracker: ブラウザ性能指標収集
- SessionTimer: セッション単位の時間追跡
- AlertSender: 閾値超過時の通知送信
```

## Experience Flow

1. **セッション開始**: 初回アクセスで診断の趣旨と期待所要時間（約4.5秒以内）を案内し、「診断を始める」を押下すると初期文字と4つの候補単語が表示される。自由入力も許容。
2. **シーン進行**: 各シーンはシンプルで読了5秒以内のテキストと4択を提示し、選択後に即座に次シーンへ遷移。進行状況（例: 2/4）が常に表示される。
3. **ローディング/エラー**: API応答遅延時はローディングメッセージ、失敗時は再試行と新セッション開始の選択肢を提供。
4. **結果表示**: タイプ名称・短い説明・キーワードタグ・極性バッジ、併せて2〜6評価軸スコアと方向性を可視化。アニメーションは1秒以内で完了し視認性を確保。
5. **次アクション**: 「もう一度診断する」「フィードバックを送る（将来拡張）」などの行動導線を用意。セッション終了時にはデータ破棄と履歴置換を実施。

## Data & Content Requirements

- 初期キーワード候補は50音から抽出した1文字を起点に、関連度スコア付き候補を4件提示する。
- シーン数はMVPで4に固定。各選択肢は対応する軸への重みベクトル（-1.0〜1.0）を持ち、キーワード補正値（-1.0〜1.0）を加味して生スコアを算出する。
- 正規化スコアは理論範囲[-5.0, 5.0]を0〜100へ線形変換し、全軸同値の場合は50に補正する。
- タイプ生成では偏差が大きい2軸を主軸とし、閾値を動的計算（平均±10pt）してHi/Loを決定する。中間域はMid説明で補完。
- UIテーマはセッションごとに一貫し、結果画面にも反映される。テーマ解析失敗時は `fallback` テーマで表示。

## Resilience & Compliance Requirements

- LLM呼び出しは1回リトライを行い、それでも失敗した場合は直ちにフォールバック資材を返す。フォールバック利用率をログ化して改善指標とする。
- セッションIDは推測困難なランダム値を用い、無効IDアクセス時は「セッションが見つかりません」と案内した上で再診断導線を提示する。
- 個人情報や永続的識別子は収集しない。ログにはセッションIDと診断メタのみを保持し、一定期間後に破棄する。
- `prefers-reduced-motion` を尊重し、アニメーションを抑制する設定を提供する。
- レスポンシブ対応は360px以上のモバイル〜デスクトップまで破綻なく表示する。フォントサイズ・タップ領域はモバイルガイドラインに従う。

## Performance Targets

### 憲章Performance Guarantees準拠仕様
- **p95レイテンシ保証**: 全エンドポイントでp95 < 2s（憲章原則）
- **シーン取得API**: p95 ≤ 800ms（目標値：憲章より厳格）
- **結果生成API**: p95 ≤ 1.2s（目標値：憲章より厳格）
- **セッション全体**: p95完了時間 ≤ 4.5s（バックエンド処理時間基準）
- **同時稼働負荷**: セッション10件で上記性能維持
- **タイプ生成処理**: 1セッションあたり5ms目安（内部計測）

### 監視・計測項目
- **Web Vitals**: FCP < 1.8s, LCP < 2.5s, FID < 100ms, CLS < 0.1
- **Custom Metrics**: セッション開始～シーン表示、シーン遷移、結果生成の各段階
- **Alert Thresholds**: p95が1.8s超過で警告、2s超過で緊急アラート
- **SLA Monitoring**: 99.5%可用性、月間ダウンタイム3.6時間以内

## Assumptions & Dependencies

- LLMは安定稼働しており、1回の再試行で多くの場合成功する。長期停止時はプリセット資材で体験を保証する。
- MVPではセッションデータの永続化を行わず、将来バージョンで履歴比較を検討する。
- 前提インプットとして docs/requirements/overview.md および docs/design 配下の設計ガイドに準拠する。
- UX/コンテンツの日本語表現はプロダクト内で統一し、専門用語は解説付きで提示する。
- テーマ切替・共有機能などの拡張要素は将来計画とし、本仕様では範囲外として扱う。

## Risks & Mitigations

| リスク | 影響 | 軽減策 |
|--------|------|--------|
| LLM応答品質の揺らぎ | 結果の信頼性低下 | 閾値検証・重複チェック・フォールバック適用 |
| シナリオ/軸の一貫性欠如 | 体験の没入感低下 | テーマIDでストーリーと結果を統一し、生成メタをログ監査 |
| 選択肢の偏り | スコア精度低下 | 重みレンジと平均チェックを自動検証 |
| ネットワーク遅延 | 離脱 | ローディング表示と再試行導線、スケルトンUIを提供 |
| コスト上振れ | 運用不可 | 推論回数をセッション内に限定し、失敗時は即フォールバック |

## Out of Scope

- ユーザー登録・履歴保存・比較機能
- A/Bテストやテーマ自動最適化
- 多言語対応およびアクセシビリティの詳細準拠（WCAG AAA 等）
- シェア画像生成やSNS連携
- セッションの分析レポート機能

## Dependencies

- LLMプロバイダ（OpenAI等）との接続およびレートリミット管理
- プリセット資材（固定シナリオ・プリセットタイプ・テーマトークン）の整備
- ロギング/モニタリング基盤（例: Datadog 相当）によるレイテンシとフォールバック比率の監視
- QA用のテストシナリオデータおよびユーザーテスト参加者の確保

## Validation & Next Steps

- 本仕様を基に `/speckit.clarify` で曖昧性の洗い出しを行う。
- その後 `/speckit.plan` で実装計画（research, plan, data-model, quickstart, contracts, tasks）を生成し、MVP着手へ進む。
