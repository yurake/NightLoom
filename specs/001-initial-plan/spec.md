# Feature Specification: NightLoom MVP診断体験

**Feature Branch**: `001-initial-plan`  
**Created**: 2025-10-14  
**Status**: Draft  
**Input**: NightLoomのMVP診断体験 — 4シーン構成の分岐型ストーリープレイを通じて動的な評価軸とタイプ分類を生成し、結果画面まで一貫したセッションを提供する機能セット。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 初回アクセスで診断を開始する (Priority: P1)

来訪ユーザーが NightLoom を開き、提示された初期キーワード候補または任意入力を用いて診断セッションを開始できる。

**Why this priority**: 診断体験の入口として最重要。セッションを開始できなければ以降の価値を提供できない。

**Independent Test**: 新規ユーザーがトップ画面からセッションを開始し、初期単語を選択すると最初のシーンが表示されることを確認すれば価値が成立する。

**Acceptance Scenarios**:

1. **Given** 新規訪問者、**When** 「診断を始める」を選択、**Then** セッションID・初期文字・候補単語が提示される
2. **Given** 候補単語、**When** 任意選択または自由入力で確定、**Then** シーン1のストーリーと選択肢が提示される
3. **Given** LLMの初期生成失敗、**When** セッション開始、**Then** 既定の2軸と固定シナリオで診断が継続される

---

### User Story 2 - 4シーンの選択体験を完走する (Priority: P2)

ユーザーが各シーンで選択を行い、セッションステータス遷移とスコア集計が正しく進む。

**Why this priority**: 行動選択を通じて性格傾向を観測するコア価値であり、全シーンの完走が必要。

**Independent Test**: 任意のシーンで選択を行い、次シーンが表示され、内部でスコアが蓄積されることを確認できれば価値が成立する。

**Acceptance Scenarios**:

1. **Given** シーンnが表示、**When** 1つの選択肢を確定、**Then** シーンn+1がロードされ進行状況が更新される
2. **Given** ネットワーク遅延、**When** 次シーン取得、**Then** ローディング表示とタイムアウト後のリトライ導線が表示される
3. **Given** LLMシーン生成失敗、**When** 次シーンを要求、**Then** 固定シナリオがシームレスに表示される

---

### User Story 3 - 結果と学びを受け取り次アクションへ進む (Priority: P3)

ユーザーが集計結果（評価軸・タイプ・キーワード）を理解し、再診断などの行動を選択できる。

**Why this priority**: 診断体験のゴールであり、ユーザーが自己理解と再挑戦の動機を得るために不可欠。

**Independent Test**: 4シーン完了後に結果画面へ遷移し、タイプ説明と軸スコアが表示され、「もう一度診断する」が機能すれば価値が成立する。

**Acceptance Scenarios**:

1. **Given** セッション完了、**When** 結果画面表示、**Then** タイプ名・説明・キーワード・2〜6軸スコアが全て表示される
2. **Given** 結果表示中、**When** 「もう一度診断する」を選択、**Then** 新セッションが発行され履歴が置き換わる
3. **Given** タイプ生成で閾値判定が揺らぐ、**When** 結果生成、**Then** 再試行またはプリセットタイプが用意され結果が欠落しない

---

### Edge Cases

- ネットワークタイムアウトやLLM API障害時にフォールバック資材へ切り替えてセッションを継続できるか
- 軸数が2未満または6超過となった場合に自動的に既定軸へ縮退できるか
- 同一ユーザーがブラウザバックで古いセッションIDを利用した際に不正アクセスとしてエラー誘導できるか
- 選択肢未入力・自由入力のバリデーション（禁止語・文字数制限）違反時に再入力を促せるか
- シーン途中でセッションが終了した際に再開ではなく新規セッションを案内できるか
- モバイル（360px幅想定）およびデスクトップでレスポンシブにUIが崩れないか
- `prefers-reduced-motion` ユーザー向けにアニメーションを抑制できるか
- LLM応答遅延により結果生成が5s超過した場合にローディングと遅延メッセージを提示できるか

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは初回アクセス時にセッションID、初期文字、候補単語を含むブートストラップ結果を返さなければならない。
- **FR-002**: システムはユーザーが候補選択または自由入力でキーワードを確定した際にセッションを`PLAY`状態へ遷移させ、シーン1を返さなければならない。
- **FR-003**: システムは各シーンでユーザーの選択結果を受け取り、重みベクトルを累積して内部スコアを更新しなければならない。
- **FR-004**: システムは4シーン完了後に評価軸スコアを0〜100へ正規化し、結果生成APIで返却しなければならない。
- **FR-005**: システムはセッションごとに2〜6軸を動的生成し、名称・説明・方向性を結果表示で利用できる形で提供しなければならない。
- **FR-006**: システムは2軸の主軸を選定し、4〜6種類のタイプ名・説明・キーワードを返却してユーザーに提示しなければならない。
- **FR-007**: システムはLLM応答失敗時に再試行し、それでも失敗した場合は既定の軸・シナリオ・タイプを用いたフォールバックを即時適用しなければならない。
- **FR-008**: システムはセッション内データをメモリ（または同等の一時領域）に限定し、結果表示後は永続化せずに破棄しなければならない。
- **FR-009**: システムはUX向上のため、各シーン取得中と結果生成中にローディング状態と失敗時の再試行導線を表示しなければならない。
- **FR-010**: システムは結果画面でAR IAラベルやキーボードフォーカス順を定義し、スクリーンリーダー利用者が主要情報を把握できるようにしなければならない。
- **FR-011**: システムは各セッションで発生したフォールバック種別・レイテンシ・エラーコードを観測ログとして記録しなければならない。
- **FR-012**: システムは「もう一度診断する」操作時に新しいセッションIDを払い出し、ブラウザ履歴を置き換えて戻る操作で旧結果が表示されないようにしなければならない。

### Key Entities *(include if feature involves data)*

- **Session**: 診断フロー全体を束ねる一時的な識別子。状態（INIT / PLAY / RESULT）と選択履歴、フォールバック有無を保持する。
- **Scene**: 各シーンのストーリーテキストと4つの選択肢。テーマIDと軸重みベクトルを含み、順次取得される。
- **Choice**: 1つの選択肢。表示テキストと軸ごとの重み、選択済みフラグを持つ。
- **AxisScore**: 2〜6軸の名称、方向性ラベル、正規化スコア。結果画面とタイプ判定に利用。
- **TypeProfile**: 主軸2本から導出されたタイプ名称・説明・キーワード・極性タグ。4〜6種生成。
- **ThemeDescriptor**: 各セッションに紐づくUIテーマIDと関連メタ。画面全体のビジュアルを統一する。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 95%のセッションで初回アクセスから結果表示までの所要時間が5分未満で完了する。
- **SC-002**: 99%のセッションでフォールバックを含め必ず結果が生成され、ユーザーが未完了で離脱しない。
- **SC-003**: 90%のユーザーが結果画面で提示されたタイプ説明を理解したと回答する（ユーザーテスト/調査）。
- **SC-004**: 80%のユーザーが「もう一度診断する」導線または共有アクションに到達し、体験継続意欲を示す。
- **SC-005**: シーン表示および結果表示のp95レイテンシがそれぞれ800ms・1.2s以内である。

## Experience Flow

1. **セッション開始**: 初回アクセスで診断の趣旨と期待所要時間（約3〜5分）を案内し、「診断を始める」を押下すると初期文字と4つの候補単語が表示される。自由入力も許容。
2. **シーン進行**: 各シーンはシンプルで読了5秒以内のテキストと4択を提示し、選択後に即座に次シーンへ遷移。進行状況（例: 2/4）が常に表示される。
3. **ローディング/エラー**: API応答遅延時はローディングメッセージ、失敗時は再試行と新セッション開始の選択肢を提供。
4. **結果表示**: タイプ名称・短い説明・キーワードタグ・極性バッジ、併せて2〜6軸スコアと方向性を可視化。アニメーションは1秒以内で完了し視認性を確保。
5. **次アクション**: 「もう一度診断する」「フィードバックを送る（将来拡張）」などの行動導線を用意。セッション終了時にはデータ破棄と履歴置換を実施。

## Data & Content Requirements

- 初期キーワード候補は50音から抽出した1文字を起点に、関連度スコア付き候補を4件提示する。
- シーン数はMVPで4に固定。各選択肢は対応する軸への重みベクトル（-1.0〜1.0）を持ち、キーワード補正値（-1.0〜1.0）を加味して生スコアを算出する。
- 正規化スコアは理論範囲[-5.0, 5.0]を0〜100へ線形変換し、全軸同値の場合は50に補正する。
- タイプ生成では偏差が大きい2軸を主軸とし、閾値を動的計算（平均±10pt）してHi/Loを決定する。中間域はMid説明で補完。
- UIテーマはセッションごとに一貫し、結果画面にも反映される。テーマ解析失敗時は `fallback` テーマで表示。

## Resilience & Compliance Requirements

- LLM呼び出しは1回リトライを行い、それでも失敗した場合は直ちにフォールバック資材を返す。フォールバック利用率をログ化して改善指標とする。
- セッションIDは推測困難なランダム値を用い、無効IDアクセス時は「セッションが見つかりません」と案内した上で再診断導線を提示する。
- 個人情報や永続的識別子は収集しない。ログにはセッションIDと診断メタのみを保持し、一定期間後に破棄する。
- `prefers-reduced-motion` を尊重し、アニメーションを抑制する設定を提供する。
- レスポンシブ対応は360px以上のモバイル〜デスクトップまで破綻なく表示する。フォントサイズ・タップ領域はモバイルガイドラインに従う。

## Performance Targets

- シーン取得APIのp95レイテンシ ≤ 800ms、結果生成APIのp95レイテンシ ≤ 1.2s。
- セッション全体（開始〜結果）のp95完了時間 ≤ 4.5s（バックエンド処理時間基準）。
- 同時稼働セッション10件で上記性能を維持する。
- タイプ生成ロジックの処理時間は1セッションあたり5ms目安（バックエンド内部計測）。

## Assumptions & Dependencies

- LLMは安定稼働しており、1回の再試行で多くの場合成功する。長期停止時はプリセット資材で体験を保証する。
- MVPではセッションデータの永続化を行わず、将来バージョンで履歴比較を検討する。
- 前提インプットとして docs/requirements/overview.md および docs/design 配下の設計ガイドに準拠する。
- UX/コンテンツの日本語表現はプロダクト内で統一し、専門用語は解説付きで提示する。
- テーマ切替・共有機能などの拡張要素は将来計画とし、本仕様では範囲外として扱う。

## Risks & Mitigations

| リスク | 影響 | 軽減策 |
|--------|------|--------|
| LLM応答品質の揺らぎ | 結果の信頼性低下 | 閾値検証・重複チェック・フォールバック適用 |
| シナリオ/軸の一貫性欠如 | 体験の没入感低下 | テーマIDでストーリーと結果を統一し、生成メタをログ監査 |
| 選択肢の偏り | スコア精度低下 | 重みレンジと平均チェックを自動検証 |
| ネットワーク遅延 | 離脱 | ローディング表示と再試行導線、スケルトンUIを提供 |
| コスト上振れ | 運用不可 | 推論回数をセッション内に限定し、失敗時は即フォールバック |

## Out of Scope

- ユーザー登録・履歴保存・比較機能
- A/Bテストやテーマ自動最適化
- 多言語対応およびアクセシビリティの詳細準拠（WCAG AAA 等）
- シェア画像生成やSNS連携
- セッションの分析レポート機能

## Dependencies

- LLMプロバイダ（OpenAI等）との接続およびレートリミット管理
- プリセット資材（固定シナリオ・プリセットタイプ・テーマトークン）の整備
- ロギング/モニタリング基盤（例: Datadog 相当）によるレイテンシとフォールバック比率の監視
- QA用のテストシナリオデータおよびユーザーテスト参加者の確保

## Validation & Next Steps

- 本仕様を基に `/speckit.clarify` で曖昧性の洗い出しを行う。
- その後 `/speckit.plan` で実装計画（research, plan, data-model, quickstart, contracts, tasks）を生成し、MVP着手へ進む。
