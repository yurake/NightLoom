# Feature Specification: NightLoom外部LLMサービス統合

**Feature Branch**: `004-nightloom-llm-openai`  
**Created**: 2025-10-20  
**Status**: Draft  
**Input**: User description: "NightLoom外部LLMサービス統合 - OpenAI GPT-4やAnthropic Claude等の実際のAI APIと接続して、動的なキーワード生成、評価軸作成、シナリオ生成、選択肢作成、結果分析を実現する機能。現在のMockLLMServiceから本格的な外部API統合への移行"

## Clarifications

### Session 2025-10-20

- Q: API プロバイダーの設定方法と切り替え条件について → A: 環境変数による設定（LLM_PROVIDER="openai"/"anthropic"）+ 対応APIキー設定
- Q: コンテンツ品質検証の具体的な基準と検証方法について → A: 実施しない（生成AI内蔵モデレーションで十分）
- Q: レート制限監視と自動フォールバック移行の具体的な閾値について → A: 95%閾値でフォールバック移行
- Q: LLMプロンプトの設計方針について → A: テンプレート化で外部設定可能

## User Scenarios & Testing *(mandatory)*

### User Story 1 - OpenAI API統合による動的キーワード生成 (Priority: P1)

開発者がOpenAI APIを設定すると、ユーザーの初期文字入力に基づいて実際のGPT-4が関連性の高いキーワード候補4つを動的生成し、従来の固定候補とは異なる個性的な診断体験を提供する。

**Why this priority**: 診断の入口であるキーワード生成が真にAI化されることで、ユーザーごとに完全にユニークな診断フローが開始される最も基本的で重要な価値提供。

**Independent Test**: OpenAI APIキーを設定してセッション開始時に、初期文字「あ」から生成されるキーワードが固定の["希望", "挑戦", "成長", "発見"]と異なる動的な候補であることを確認できれば独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** OpenAI APIキーが設定済み、**When** 初期文字「あ」でセッション開始、**Then** GPT-4が生成した関連キーワード4つが返される
2. **Given** OpenAI API障害発生、**When** セッション開始、**Then** フォールバック候補が即座に提供され診断が継続される  
3. **Given** 異なる初期文字、**When** 複数回セッション開始、**Then** 毎回異なるキーワード候補が生成される

---

### User Story 2 - 動的評価軸生成による個性化診断 (Priority: P2)

ユーザーが選択したキーワードに基づいて、GPT-4が2〜6軸の評価軸を動的生成し、従来の固定4軸（論理性、迅速性、個人性、安定性）ではなく、そのキーワードに最適化された個別の評価軸で診断を実施する。

**Why this priority**: 評価軸がキーワードに連動することで、同じ診断システムでもユーザーごとに完全に異なる心理分析アプローチが可能になる。

**Independent Test**: キーワード「愛」と「冒険」で別々にセッションを開始し、生成される評価軸が異なること、かつ固定4軸と異なることを確認できれば独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** キーワード「愛」選択、**When** 評価軸生成、**Then** 愛に関連した評価軸（例：「包容的⟷排他的」）が含まれる
2. **Given** キーワード「冒険」選択、**When** 評価軸生成、**Then** 冒険に関連した評価軸（例：「慎重⟷大胆」）が含まれる
3. **Given** 同じキーワードで複数回実行、**When** 評価軸生成、**Then** 一貫性のある軸が生成される

---

### User Story 3 - AIシナリオ・選択肢生成による没入体験 (Priority: P3)

各シーンで、選択されたキーワードと生成された評価軸に基づいて、GPT-4がリアルタイムでシナリオテキストと4つの選択肢を生成し、固定テンプレートではない個別のストーリー体験を提供する。

**Why this priority**: 診断の核となる選択体験が完全にAI生成されることで、真の個別化された心理診断体験が実現される。

**Independent Test**: 同じキーワードでも異なる評価軸設定で診断を実行し、シナリオ内容と選択肢が動的に変化することを確認できれば独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** 評価軸とキーワード設定、**When** シーン1生成、**Then** キーワードを含む個別ストーリーと軸対応選択肢が生成される
2. **Given** シーン進行中、**When** 次シーン生成、**Then** 前の選択を考慮した連続性のあるシナリオが生成される
3. **Given** LLMシーン生成失敗、**When** シーン要求、**Then** フォールバックシナリオで診断継続される

---

### User Story 4 - AI結果分析による洞察生成 (Priority: P4)

4シーン完了後、ユーザーの選択パターンと評価軸スコアに基づいて、GPT-4が個別のタイプ分析とパーソナリティ洞察を生成し、固定6タイプではない真にパーソナライズされた結果を提示する。

**Why this priority**: 診断結果が固定テンプレートから脱却し、ユーザー個人に特化した心理的洞察を提供することで診断の価値が最大化される。

**Independent Test**: 同じスコアパターンでも異なるキーワード・軸設定で結果生成を実行し、異なる分析結果が得られることを確認できれば独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** 4シーン完了、**When** 結果生成、**Then** キーワードと軸に特化したタイプ分析が生成される
2. **Given** 極端なスコア分布、**When** 結果生成、**Then** そのパターンに対する具体的な洞察が含まれる
3. **Given** AI結果生成失敗、**When** 結果要求、**Then** フォールバックタイプで結果表示される

---

### Edge Cases

- OpenAI API レート制限超過時の自動フォールバック動作
- API応答が5秒を超過した場合のタイムアウト処理
- 生成されたコンテンツが不適切な場合の検証・再生成
- API キー未設定時の自動Mock/Fallbackモード移行
- 生成された軸数が2未満・6超過の場合の補正処理
- 選択肢の重みベクトルがバランスしていない場合の調整
- 同時大量リクエスト時のAPI呼び出し制御

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは環境変数LLM_PROVIDERと対応APIキー（OPENAI_API_KEY/ANTHROPIC_API_KEY）が設定された場合、MockLLMServiceからExternalLLMServiceに自動切り替えしなければならない
- **FR-002**: システムはテンプレート化されたプロンプトを使用して初期文字に基づくキーワード候補4つを生成し、関連性とバラエティを確保しなければならない
- **FR-003**: システムはテンプレート化されたプロンプトを使用してキーワードに基づく2〜6軸の評価軸を動的生成し、軸名・説明・方向性を日本語で提供しなければならない
- **FR-004**: システムはテンプレート化されたプロンプトを使用して各シーンの評価軸とキーワードに連動したシナリオと選択肢4つを生成しなければならない
- **FR-005**: システムはテンプレート化されたプロンプトを使用して4シーン完了後の個別タイプ分析とパーソナリティ洞察を生成しなければならない
- **FR-006**: システムはすべてのLLM呼び出しで1回のリトライを実行し、失敗時は既存フォールバック資産を使用しなければならない
- **FR-007**: システムはLLM応答時間を監視し、5秒超過時にタイムアウトしてフォールバックを適用しなければならない
- **FR-008**: システムは形式検証（JSON構造、必須フィールド存在）のみ実施し、コンテンツ品質はLLM内蔵モデレーションに依存しなければならない
- **FR-009**: システムはLLM_PROVIDER環境変数により"openai"/"anthropic"/"mock"の切り替えを提供し、対応APIキーの存在確認を行わなければならない
- **FR-010**: システムはAPI使用量を監視し、レート制限の95%到達時にフォールバックモードに自動移行しなければならない

### Key Entities *(include if feature involves data)*

- **LLMProvider**: 外部AI API提供者の情報（OpenAI、Anthropic等）
- **LLMRequest**: AI APIへの要求内容（プロンプト、パラメータ、レスポンス）
- **PromptTemplate**: 各機能別のプロンプトテンプレート（キーワード生成、軸作成、シナリオ生成、結果分析）
- **ContentValidation**: 生成コンテンツの品質検証結果
- **APIUsageMetrics**: API使用量とレート制限監視データ

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: OpenAI API統合により95%のセッションで動的キーワード生成が成功する
- **SC-002**: 生成されたキーワードの関連性がユーザー評価で平均4.0/5.0以上を達成する
- **SC-003**: 動的評価軸生成により同じキーワードでも80%以上の一貫性を保持する
- **SC-004**: AIシナリオ生成により固定テンプレートと比較してユーザーエンゲージメントが30%向上する
- **SC-005**: API障害時のフォールバック切り替えが500ms以内で完了する
- **SC-006**: 全LLM処理を含む診断完了時間がp95で8秒以内を維持する
- **SC-007**: API使用コストが1セッションあたり0.05USD以内に収まる
- **SC-008**: 生成コンテンツの形式検証で99%以上が正しい構造を持つ
