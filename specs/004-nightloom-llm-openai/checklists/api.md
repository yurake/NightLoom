# API統合品質 Checklist: NightLoom外部LLMサービス統合

**Purpose**: 外部LLMサービス（OpenAI、Anthropic）とのAPI統合要件の完整性と明確性を検証
**Created**: 2025-10-25
**Feature**: [spec.md](../spec.md)

**Note**: この要件品質チェックリストは機能の実装テストではなく、要件定義の品質検証を目的としています。

## API プロバイダー設定要件

- [x] CHK001 API プロバイダーの設定方法は環境変数を通じて明確に定義されているか？ *[FR-009]* ✅ [Spec §Clarifications, FR-009] 環境変数明記済み
- [x] CHK002 サポートする LLM プロバイダー（"openai"/"anthropic"/"mock"）の切り替え条件は明確に規定されているか？ *[FR-001, FR-009]* ✅ [FR-001, FR-009] 切り替え条件明記
- [x] CHK003 各プロバイダーに必要な認証情報（OPENAI_API_KEY, ANTHROPIC_API_KEY）の設定要件は完全に文書化されているか？ *[FR-001]* ✅ [FR-001] APIキー要件明記
- [x] CHK004 API キー未設定時の自動フォールバック動作は具体的に定義されているか？ *[Edge Cases]* ✅ [Edge Cases, FR-006] 未設定時のMock/Fallback明記

## API 呼び出し仕様要件

- [ ] CHK005 各 LLM 機能（キーワード生成、評価軸作成、シナリオ生成、結果分析）のAPI呼び出しパラメータは完全に定義されているか？ *[FR-002, FR-003, FR-004, FR-005]* ⚠️ [FR-002〜FR-005] パラメータ例・型がやや抽象的。JSON例や型定義追加推奨
- [x] CHK006 プロンプトテンプレート化の要件とテンプレートファイルの管理方法は明確に規定されているか？ *[FR-002, FR-003, FR-004, FR-005]* ✅ [FR-002〜FR-005, Plan] テンプレート管理明記
- [ ] CHK007 各 API 呼び出しの期待される応答形式（JSON構造、必須フィールド）は明確に定義されているか？ *[FR-008]* ⚠️ [FR-008] 必須フィールドは明記だが、応答JSON例が不足。例示追加推奨
- [x] CHK008 API 応答の形式検証要件は具体的に規定されているか（コンテンツ品質検証の除外含む）？ *[FR-008]* ✅ [FR-008] 形式検証要件明記

## エラーハンドリング要件

- [ ] CHK009 API 呼び出し失敗時のリトライ仕様（回数、間隔、条件）は明確に定義されているか？ *[FR-006]* ⚠️ [FR-006] リトライ回数・間隔が明確でない。具体値明記推奨
- [x] CHK010 API タイムアウト条件（5秒超過）とタイムアウト時の処理は具体的に規定されているか？ *[FR-007]* ✅ [FR-007, Edge Cases] 5秒タイムアウト明記
- [x] CHK011 各 LLM 機能のフォールバック資産への切り替え条件は明確に定義されているか？ *[FR-006]* ✅ [FR-006] フォールバック切替条件明記
- [x] CHK012 レート制限超過（95%閾値）の検出方法と自動フォールバック移行は具体的に規定されているか？ *[FR-010]* ✅ [FR-010, Edge Cases] 95%閾値明記

## パフォーマンス要件

- [ ] CHK013 各 API 呼び出しの応答時間要件は定量的に定義されているか？ *[SC-006]* ⚠️ [SC-006, Plan] 応答時間目標はあるが、API単位の定量値が曖昧。APIごとに明記推奨
- [x] CHK014 API 使用量監視の要件（メトリクス収集、閾値設定）は明確に規定されているか？ *[FR-010]* ✅ [FR-010, Plan] 監視要件明記
- [ ] CHK015 セッションあたりのAPI使用コスト制限（0.05USD）の管理方法は具体的に定義されているか？ *[SC-007]* ⚠️ [SC-007] コスト制限値は明記だが、超過時の動作が曖昧。明確化推奨
- [ ] CHK016 同時大量リクエスト時のAPI呼び出し制御方法は明確に規定されているか？ *[Edge Cases]* ⚠️ [Edge Cases] 制御方法が抽象的。具体的な制御アルゴリズム例追加推奨

## データフロー要件

- [x] CHK017 セッション内でのLLM応答データの一時保持仕様は明確に定義されているか？ *[Technical Context]* ✅ [Plan, Technical Context] 一時保持仕様明記
- [x] CHK018 各シーン間でのデータ継続性要件（前の選択を考慮した連続性）は具体的に規定されているか？ *[US3 - Acceptance Scenarios]* ✅ [US3, Acceptance Scenarios] データ継続性明記
- [x] CHK019 生成コンテンツの品質保証方法（LLM内蔵モデレーション依存）は明確に文書化されているか？ *[FR-008]* ✅ [FR-008, Clarifications] モデレーション依存明記
- [x] CHK020 動的生成コンテンツと既存フォールバック資産との互換性要件は定義されているか？ *[FR-006]* ✅ [FR-006] 互換性要件明記

## 統合品質要件

- [x] CHK021 各ユーザーストーリーの独立テスト可能性は明確に定義されているか？ *[User Story Independent Tests]* ✅ [User Story, Acceptance Scenarios] 独立テスト可能性明記
- [x] CHK022 既存 MockLLMService からの移行要件と互換性保持は具体的に規定されているか？ *[FR-001]* ✅ [FR-001, Plan] Mock→外部LLM移行要件明記
- [x] CHK023 フロントエンド API との互換性維持要件は明確に定義されているか？ *[Plan Structure Decision]* ✅ [Plan, Structure Decision] フロント互換性明記
- [ ] CHK024 プロダクション環境でのAPI統合デプロイメント要件は完全に文書化されているか？ *[Tasks T069]* ⚠️ [Tasks T069] デプロイメント要件がタスクのみ。要件本文への明記推奨

## セキュリティ要件

- [x] CHK025 API認証情報の安全な管理と設定方法は明確に規定されているか？ *[FR-001, FR-009]* ✅ [FR-001, FR-009] 認証情報管理明記
- [ ] CHK026 外部 LLM サービスとの通信セキュリティ要件は定義されているか？ ⚠️ 通信セキュリティ（TLS等）要件が明記されていない。明記推奨
- [ ] CHK027 生成コンテンツのセキュリティ検証要件（不適切コンテンツ対策）は明確に規定されているか？ *[Edge Cases]* ⚠️ 不適切コンテンツ対策が「モデレーション依存」のみ。再生成や遮断条件の明記推奨
- [ ] CHK028 API使用量データとメトリクスの保護要件は定義されているか？ *[APIUsageMetrics]* ⚠️ メトリクス保護要件が抽象的。アクセス制御等の明記推奨

## 検証結果サマリー

**判定結果**: 
- ✅: 19/28（約68%）…明確・十分
- ⚠️: 9/28（約32%）…要改善（曖昧・例示不足・記述漏れ）
- ❌: 0/28

**重要な要改善点（高優先度）**:
- CHK005, CHK007: APIパラメータ・応答形式の具体例・型定義不足
- CHK009: リトライ仕様の具体値未記載
- CHK013, CHK015, CHK016: パフォーマンス・コスト・同時リクエスト制御の具体性不足
- CHK026: 通信セキュリティ要件未記載
- CHK027: 不適切コンテンツ対策の詳細未記載

**中優先度**:
- CHK024: デプロイメント要件（タスクのみ）
- CHK028: メトリクス保護要件の具体性不足

**推奨アクション**:
1. API仕様の具体例・型定義・JSON例をspec.mdに追記
2. リトライ・コスト・同時リクエスト制御等の具体値・アルゴリズム例を明記
3. 通信セキュリティ（TLS必須等）・生成物セキュリティ対策（再生成/遮断条件）を明記
4. デプロイメント・メトリクス保護要件の本文記載強化

**総合評価**: 
要件の網羅性・一貫性は高いが、実装・テスト観点での具体性（例示・型・制御フロー・セキュリティ）が不足している部分が複数あり。実装開始前にspec.md/plan.mdへの上記改善点の反映を推奨。

## Notes

- トレーサビリティ参照: *[FR-XXX]* = 機能要件、*[SC-XXX]* = 成功基準、*[US#]* = ユーザーストーリー
- 各項目は要件の「存在」と「明確性」を検証し、実装の詳細ではなく要件品質に焦点を当てる
- 不足している要件や曖昧な表現が発見された場合は、spec.md の改善が必要
- 検証実施日: 2025-10-25
