============================= test session starts ==============================
platform darwin -- Python 3.12.8, pytest-8.4.2, pluggy-1.6.0 -- /Users/yurak/git/NightLoom/backend/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/yurak/git/NightLoom/backend
configfile: pyproject.toml
plugins: respx-0.22.0, asyncio-1.2.0, anyio-4.11.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 4 items

tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_too_long_keyword FAILED [ 25%]
tests/api/test_keyword.py::TestKeywordConfirmationEdgeCases::test_keyword_confirmation_twice_same_session FAILED [ 50%]
tests/api/test_results.py::TestResultRetrieval::test_get_result_invalid_session_state PASSED [ 75%]
tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_llm_service_unavailable FAILED [100%]

=================================== FAILURES ===================================
____ TestKeywordConfirmationAPI.test_keyword_confirmation_too_long_keyword _____
tests/api/test_keyword.py:181: in test_keyword_confirmation_too_long_keyword
    assert response.status_code == 500
E   assert 200 == 500
E    +  where 200 = <Response [200 OK]>.status_code
----------------------------- Captured stdout call -----------------------------
[NIGHTLOOM] {"event_type": "session_start", "timestamp": "2025-10-16T04:57:55.100450", "session_id": "a0f4a613-5efa-49bd-8b40-129316bca05c", "initial_character": "\u3042", "theme_id": "serene", "fallback_used": false}
[NIGHTLOOM] {"event_type": "keyword_confirmation", "timestamp": "2025-10-16T04:57:55.303783", "session_id": "a0f4a613-5efa-49bd-8b40-129316bca05c", "keyword": "\u3053\u308c\u306f\u975e\u5e38\u306b\u9577\u3044\u30ad\u30fc\u30ef\u30fc\u30c9\u3067\u30c6\u30b9\u30c8\u3057\u307e\u3059", "source": "manual", "latency_ms": 201.2481689453125}
_ TestKeywordConfirmationEdgeCases.test_keyword_confirmation_twice_same_session _
tests/api/test_keyword.py:355: in test_keyword_confirmation_twice_same_session
    assert response2.status_code == 500
E   assert 400 == 500
E    +  where 400 = <Response [400 Bad Request]>.status_code
----------------------------- Captured stdout call -----------------------------
[NIGHTLOOM] {"event_type": "session_start", "timestamp": "2025-10-16T04:57:55.429222", "session_id": "336303b9-6a5b-41e2-b617-7f9c8d749c44", "initial_character": "\u3042", "theme_id": "serene", "fallback_used": false}
[NIGHTLOOM] {"event_type": "keyword_confirmation", "timestamp": "2025-10-16T04:57:55.631935", "session_id": "336303b9-6a5b-41e2-b617-7f9c8d749c44", "keyword": "\u611b", "source": "suggestion", "latency_ms": 201.2808322906494}
__________ TestSceneRetrieval.test_get_scene_llm_service_unavailable ___________
tests/api/test_scenes.py:163: in test_get_scene_llm_service_unavailable
    assert data["fallbackUsed"] is True
E   assert False is True
----------------------------- Captured stdout call -----------------------------
[METRIC] Counter scene_retrieval_success incremented
[METRIC] scene_retrieval latency: 0.03ms
=============================== warnings summary ===============================
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
  /Users/yurak/git/NightLoom/backend/.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_too_long_keyword
tests/api/test_keyword.py::TestKeywordConfirmationEdgeCases::test_keyword_confirmation_twice_same_session
  /Users/yurak/git/NightLoom/backend/app/services/session.py:84: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    createdAt=datetime.utcnow()

tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_too_long_keyword
tests/api/test_keyword.py::TestKeywordConfirmationEdgeCases::test_keyword_confirmation_twice_same_session
  /Users/yurak/git/NightLoom/backend/app/services/observability.py:32: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "timestamp": datetime.utcnow().isoformat(),

tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_too_long_keyword
tests/api/test_keyword.py::TestKeywordConfirmationEdgeCases::test_keyword_confirmation_twice_same_session
  /Users/yurak/git/NightLoom/backend/app/services/observability.py:59: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "timestamp": datetime.utcnow().isoformat(),

tests/api/test_results.py::TestResultRetrieval::test_get_result_invalid_session_state
tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_llm_service_unavailable
  /Users/yurak/git/NightLoom/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:253: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)

tests/api/test_results.py::TestResultRetrieval::test_get_result_invalid_session_state
  /Users/yurak/git/NightLoom/backend/app/services/observability.py:328: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return datetime.utcnow().isoformat()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_too_long_keyword
FAILED tests/api/test_keyword.py::TestKeywordConfirmationEdgeCases::test_keyword_confirmation_twice_same_session
FAILED tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_llm_service_unavailable
=================== 3 failed, 1 passed, 16 warnings in 0.76s ===================
