============================= test session starts ==============================
platform darwin -- Python 3.12.8, pytest-8.4.2, pluggy-1.6.0 -- /Users/yurak/git/NightLoom/backend/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/yurak/git/NightLoom/backend
configfile: pyproject.toml
plugins: respx-0.22.0, asyncio-1.2.0, anyio-4.11.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 59 items

tests/api/test_bootstrap.py::TestBootstrapAPI::test_bootstrap_success PASSED [  1%]
tests/api/test_bootstrap.py::TestBootstrapAPI::test_bootstrap_with_custom_character PASSED [  3%]
tests/api/test_bootstrap.py::TestBootstrapAPI::test_bootstrap_with_llm_fallback PASSED [  5%]
tests/api/test_bootstrap.py::TestBootstrapAPI::test_bootstrap_multiple_sessions PASSED [  6%]
tests/api/test_bootstrap.py::TestBootstrapAPI::test_bootstrap_response_performance PASSED [  8%]
tests/api/test_bootstrap.py::TestBootstrapAPI::test_bootstrap_session_storage PASSED [ 10%]
tests/api/test_bootstrap.py::TestBootstrapAPI::test_bootstrap_invalid_request_body PASSED [ 11%]
tests/api/test_bootstrap.py::TestBootstrapAPI::test_bootstrap_observability_logging PASSED [ 13%]
tests/api/test_bootstrap.py::TestBootstrapEdgeCases::test_bootstrap_with_empty_body PASSED [ 15%]
tests/api/test_bootstrap.py::TestBootstrapEdgeCases::test_bootstrap_concurrent_requests PASSED [ 16%]
tests/api/test_bootstrap.py::TestBootstrapEdgeCases::test_bootstrap_memory_usage PASSED [ 18%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_valid_session_and_choice PASSED [ 20%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_last_scene_no_next PASSED [ 22%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_session_not_found PASSED [ 23%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_invalid_session_state PASSED [ 25%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_invalid_choice_id PASSED [ 27%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_missing_choice_id PASSED [ 28%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_invalid_scene_index PASSED [ 30%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_malformed_request_body PASSED [ 32%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_llm_service_unavailable PASSED [ 33%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_score_accumulation_tracking PASSED [ 35%]
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_performance_contract PASSED [ 37%]
tests/api/test_choices.py::TestChoiceValidation::test_choice_id_format_validation PASSED [ 38%]
tests/api/test_choices.py::TestChoiceValidation::test_choice_submission_sequence PASSED [ 40%]
tests/api/test_choices.py::TestChoiceValidation::test_duplicate_choice_submission PASSED [ 42%]
tests/api/test_health.py::test_health_endpoint[asyncio] PASSED           [ 44%]
tests/api/test_health.py::test_health_endpoint[trio] PASSED              [ 45%]
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_success PASSED [ 47%]
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_custom_keyword PASSED [ 49%]
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_invalid_session FAILED [ 50%]
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_invalid_session_id_format FAILED [ 52%]
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_empty_keyword FAILED [ 54%]
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_too_long_keyword FAILED [ 55%]
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_missing_request_fields PASSED [ 57%]
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_performance PASSED [ 59%]
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_scene_narrative_contains_keyword PASSED [ 61%]
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_observability_logging PASSED [ 62%]
tests/api/test_keyword.py::TestKeywordConfirmationEdgeCases::test_keyword_confirmation_japanese_characters PASSED [ 64%]
tests/api/test_keyword.py::TestKeywordConfirmationEdgeCases::test_keyword_confirmation_twice_same_session FAILED [ 66%]
tests/api/test_results.py::TestResultRetrieval::test_get_result_completed_session PASSED [ 67%]
tests/api/test_results.py::TestResultRetrieval::test_get_result_session_not_found PASSED [ 69%]
tests/api/test_results.py::TestResultRetrieval::test_get_result_session_not_completed FAILED [ 71%]
tests/api/test_results.py::TestResultRetrieval::test_get_result_invalid_session_state FAILED [ 72%]
tests/api/test_results.py::TestResultRetrieval::test_get_result_llm_service_unavailable_with_fallback PASSED [ 74%]
tests/api/test_results.py::TestResultRetrieval::test_get_result_llm_service_complete_failure FAILED [ 76%]
tests/api/test_results.py::TestResultRetrieval::test_get_result_malformed_session_id FAILED [ 77%]
tests/api/test_results.py::TestResultRetrieval::test_get_result_performance_contract PASSED [ 79%]
tests/api/test_results.py::TestResultDataValidation::test_axis_score_normalization PASSED [ 81%]
tests/api/test_results.py::TestResultDataValidation::test_type_profile_count_validation PASSED [ 83%]
tests/api/test_results.py::TestResultDataValidation::test_dominant_axes_consistency PASSED [ 84%]
tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_valid_session_and_index PASSED [ 86%]
tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_session_not_found PASSED [ 88%]
tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_invalid_session_state PASSED [ 89%]
tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_invalid_scene_index PASSED [ 91%]
tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_llm_service_unavailable FAILED [ 93%]
tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_malformed_uuid FAILED [ 94%]
tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_performance_contract PASSED [ 96%]
tests/api/test_scenes.py::TestSceneProgressTracking::test_scene_sequence_validation PASSED [ 98%]
tests/api/test_scenes.py::TestSceneProgressTracking::test_scene_data_consistency PASSED [100%]

=================================== FAILURES ===================================
_____ TestKeywordConfirmationAPI.test_keyword_confirmation_invalid_session _____
tests/api/test_keyword.py:119: in test_keyword_confirmation_invalid_session
    assert "not found" in response.json()["detail"].lower()
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'dict' object has no attribute 'lower'
----------------------------- Captured stdout call -----------------------------
[NIGHTLOOM] {"event_type": "error", "timestamp": "2025-10-16T04:53:21.485396", "session_id": "ead8a5fd-7afd-48e0-9aad-50c291b6d27a", "error_type": "keyword_confirmation_error", "error_message": "Session ead8a5fd-7afd-48e0-9aad-50c291b6d27a not found", "context": {}}
_ TestKeywordConfirmationAPI.test_keyword_confirmation_invalid_session_id_format _
tests/api/test_keyword.py:136: in test_keyword_confirmation_invalid_session_id_format
    assert "Invalid session ID format" in response.json()["detail"]
E   AssertionError: assert 'Invalid session ID format' in {'details': {'error': 'badly formed hexadecimal UUID string', 'session_id': 'invalid-uuid-format'}, 'error_code': 'VALIDATION_ERROR', 'message': 'Invalid session ID format'}
______ TestKeywordConfirmationAPI.test_keyword_confirmation_empty_keyword ______
tests/api/test_keyword.py:159: in test_keyword_confirmation_empty_keyword
    assert "Invalid keyword" in response.json()["detail"]
E   AssertionError: assert 'Invalid keyword' in {'details': {'error': 'Invalid keyword length', 'keyword': '', 'session_id': '3f1cf721-2373-430d-9e9b-25a850c3dac9'}, 'error_code': 'VALIDATION_ERROR', 'message': 'Keyword validation failed'}
----------------------------- Captured stdout call -----------------------------
[NIGHTLOOM] {"event_type": "session_start", "timestamp": "2025-10-16T04:53:21.630550", "session_id": "3f1cf721-2373-430d-9e9b-25a850c3dac9", "initial_character": "\u3042", "theme_id": "serene", "fallback_used": false}
[NIGHTLOOM] {"event_type": "error", "timestamp": "2025-10-16T04:53:21.632303", "session_id": "3f1cf721-2373-430d-9e9b-25a850c3dac9", "error_type": "keyword_confirmation_error", "error_message": "Invalid keyword length", "context": {}}
____ TestKeywordConfirmationAPI.test_keyword_confirmation_too_long_keyword _____
tests/api/test_keyword.py:181: in test_keyword_confirmation_too_long_keyword
    assert response.status_code == 500
E   assert 200 == 500
E    +  where 200 = <Response [200 OK]>.status_code
----------------------------- Captured stdout call -----------------------------
[NIGHTLOOM] {"event_type": "session_start", "timestamp": "2025-10-16T04:53:21.740297", "session_id": "511b09ae-2cc9-4980-bd01-28c852125e0a", "initial_character": "\u3042", "theme_id": "serene", "fallback_used": false}
[NIGHTLOOM] {"event_type": "keyword_confirmation", "timestamp": "2025-10-16T04:53:21.944014", "session_id": "511b09ae-2cc9-4980-bd01-28c852125e0a", "keyword": "\u3053\u308c\u306f\u975e\u5e38\u306b\u9577\u3044\u30ad\u30fc\u30ef\u30fc\u30c9\u3067\u30c6\u30b9\u30c8\u3057\u307e\u3059", "source": "manual", "latency_ms": 201.26700401306152}
_ TestKeywordConfirmationEdgeCases.test_keyword_confirmation_twice_same_session _
tests/api/test_keyword.py:355: in test_keyword_confirmation_twice_same_session
    assert response2.status_code == 500
E   assert 400 == 500
E    +  where 400 = <Response [400 Bad Request]>.status_code
----------------------------- Captured stdout call -----------------------------
[NIGHTLOOM] {"event_type": "session_start", "timestamp": "2025-10-16T04:53:23.394426", "session_id": "af62eaaf-a2b0-4b0e-8acc-8c9e19169e5b", "initial_character": "\u3042", "theme_id": "serene", "fallback_used": false}
[NIGHTLOOM] {"event_type": "keyword_confirmation", "timestamp": "2025-10-16T04:53:23.596722", "session_id": "af62eaaf-a2b0-4b0e-8acc-8c9e19169e5b", "keyword": "\u611b", "source": "suggestion", "latency_ms": 201.10607147216797}
__________ TestResultRetrieval.test_get_result_session_not_completed ___________
tests/api/test_results.py:193: in test_get_result_session_not_completed
    assert data["error_code"] == "SESSION_NOT_COMPLETED"
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'error_code'
----------------------------- Captured stdout call -----------------------------
[METRIC] Counter result_generation_invalid_state incremented
__________ TestResultRetrieval.test_get_result_invalid_session_state ___________
tests/api/test_results.py:215: in test_get_result_invalid_session_state
    assert data["error_code"] == "BAD_REQUEST"
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'error_code'
----------------------------- Captured stdout call -----------------------------
[METRIC] Counter result_generation_invalid_state incremented
_______ TestResultRetrieval.test_get_result_llm_service_complete_failure _______
tests/api/test_results.py:335: in test_get_result_llm_service_complete_failure
    assert data["error_code"] == "LLM_SERVICE_UNAVAILABLE"
           ^^^^^^^^^^^^^^^^^^
E   KeyError: 'error_code'
----------------------------- Captured stdout call -----------------------------
[METRIC] Counter result_generation_unexpected_error incremented
[ERROR] {"level": "error", "message": "Unexpected error in result generation", "timestamp": "2025-10-16T04:53:23.623569", "session_id": "0d64b423-4872-4a51-bc57-5235623b229a", "error": "Complete LLM failure"}
___________ TestResultRetrieval.test_get_result_malformed_session_id ___________
tests/api/test_results.py:345: in test_get_result_malformed_session_id
    assert data["error_code"] == "BAD_REQUEST"
E   AssertionError: assert 'VALIDATION_ERROR' == 'BAD_REQUEST'
E     
E     - BAD_REQUEST
E     + VALIDATION_ERROR
__________ TestSceneRetrieval.test_get_scene_llm_service_unavailable ___________
tests/api/test_scenes.py:163: in test_get_scene_llm_service_unavailable
    assert data["fallbackUsed"] is True
E   assert False is True
----------------------------- Captured stdout call -----------------------------
[METRIC] Counter scene_retrieval_success incremented
[METRIC] scene_retrieval latency: 0.08ms
_______________ TestSceneRetrieval.test_get_scene_malformed_uuid _______________
tests/api/test_scenes.py:177: in test_get_scene_malformed_uuid
    assert data["error_code"] == "BAD_REQUEST"
E   AssertionError: assert 'VALIDATION_ERROR' == 'BAD_REQUEST'
E     
E     - BAD_REQUEST
E     + VALIDATION_ERROR
=============================== warnings summary ===============================
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323
  /Users/yurak/git/NightLoom/backend/.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/api/test_bootstrap.py: 25 warnings
tests/api/test_keyword.py: 10 warnings
  /Users/yurak/git/NightLoom/backend/app/services/session.py:84: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    createdAt=datetime.utcnow()

tests/api/test_bootstrap.py: 25 warnings
tests/api/test_keyword.py: 10 warnings
  /Users/yurak/git/NightLoom/backend/app/services/observability.py:32: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "timestamp": datetime.utcnow().isoformat(),

tests/api/test_bootstrap.py::TestBootstrapAPI::test_bootstrap_with_llm_fallback
  /Users/yurak/git/NightLoom/backend/tests/api/test_bootstrap.py:104: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    createdAt=datetime.utcnow()

tests/api/test_choices.py: 11 warnings
tests/api/test_results.py: 9 warnings
tests/api/test_scenes.py: 7 warnings
  /Users/yurak/git/NightLoom/backend/.venv/lib/python3.12/site-packages/pydantic/main.py:253: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)

tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_valid_session_and_choice
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_last_scene_no_next
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_llm_service_unavailable
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_score_accumulation_tracking
tests/api/test_choices.py::TestChoiceSubmission::test_submit_choice_performance_contract
tests/api/test_choices.py::TestChoiceValidation::test_duplicate_choice_submission
  /Users/yurak/git/NightLoom/backend/app/services/session.py:252: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    timestamp=datetime.utcnow()

tests/api/test_choices.py: 17 warnings
tests/api/test_keyword.py: 1 warning
tests/api/test_results.py: 12 warnings
tests/api/test_scenes.py: 6 warnings
  /Users/yurak/git/NightLoom/backend/app/services/observability.py:328: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return datetime.utcnow().isoformat()

tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_success
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_custom_keyword
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_too_long_keyword
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_performance
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_scene_narrative_contains_keyword
tests/api/test_keyword.py::TestKeywordConfirmationEdgeCases::test_keyword_confirmation_japanese_characters
tests/api/test_keyword.py::TestKeywordConfirmationEdgeCases::test_keyword_confirmation_twice_same_session
  /Users/yurak/git/NightLoom/backend/app/services/observability.py:59: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "timestamp": datetime.utcnow().isoformat(),

tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_invalid_session
tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_empty_keyword
  /Users/yurak/git/NightLoom/backend/app/services/observability.py:193: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    "timestamp": datetime.utcnow().isoformat(),

tests/api/test_results.py::TestResultRetrieval::test_get_result_completed_session
tests/api/test_results.py::TestResultRetrieval::test_get_result_completed_session
tests/api/test_results.py::TestResultRetrieval::test_get_result_completed_session
  /Users/yurak/git/NightLoom/backend/tests/api/test_results.py:88: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    "axes": [axis.dict() for axis in mock_axes],

tests/api/test_results.py::TestResultRetrieval::test_get_result_completed_session
tests/api/test_results.py::TestResultRetrieval::test_get_result_completed_session
tests/api/test_results.py::TestResultRetrieval::test_get_result_completed_session
tests/api/test_results.py::TestResultRetrieval::test_get_result_completed_session
  /Users/yurak/git/NightLoom/backend/tests/api/test_results.py:91: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    "profiles": [profile.dict() for profile in mock_type_profiles],

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_invalid_session
FAILED tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_invalid_session_id_format
FAILED tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_empty_keyword
FAILED tests/api/test_keyword.py::TestKeywordConfirmationAPI::test_keyword_confirmation_too_long_keyword
FAILED tests/api/test_keyword.py::TestKeywordConfirmationEdgeCases::test_keyword_confirmation_twice_same_session
FAILED tests/api/test_results.py::TestResultRetrieval::test_get_result_session_not_completed
FAILED tests/api/test_results.py::TestResultRetrieval::test_get_result_invalid_session_state
FAILED tests/api/test_results.py::TestResultRetrieval::test_get_result_llm_service_complete_failure
FAILED tests/api/test_results.py::TestResultRetrieval::test_get_result_malformed_session_id
FAILED tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_llm_service_unavailable
FAILED tests/api/test_scenes.py::TestSceneRetrieval::test_get_scene_malformed_uuid
================= 11 failed, 48 passed, 163 warnings in 5.21s ==================
