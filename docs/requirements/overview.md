# 性格指向性観測アプリ 要件定義書

## 1. タイトル
性格指向性観測 Web アプリケーション 要件定義 (MVP)

## 2. バージョン / 改訂履歴
| Version | 日付 | 区分 | 記述 | 作成者 |
|---------|------|------|------|--------|
| 0.1.0 (Draft) | 2025-10-06 | 初版 | MVP 初期要件確定 | Team |

## 3. ビジョン
ユーザーが短時間の分岐型シナリオ体験を通じて、自身の行動傾向・意思決定指向性を理解できるようにする。AI により毎セッション動的に評価軸とタイプ分類を生成し、ゲーム的没入と再利用性を両立する。

## 4. スコープ
### 4.1 In Scope (MVP)
- 4シーン × 各4選択肢による単一セッション
- シナリオ/選択肢文面のAI生成（高密度短尺・スピード優先）
- 選択パターン解析（内部スコア加算）
- AI 生成された 2〜6 評価軸スコア (0〜100 正規化)
- ハイブリッド型タイプ分類（評価軸極性組合せ）
- 結果表示（軸スコア一覧 + タイプ名 + タイプ説明）
- フェイルオーバー（再試行 + プリセット固定シナリオ/タイプ）
- Web SPA（PC/モバイル対応）
- セッション内のみの一時データ保持（永続化なし）
### 4.2 Out of Scope (明示的除外)
- ユーザー登録 / 認証
- 履歴保存・再参照
- A/B テスト基盤
- 国際化 (i18n)
- アクセシビリティ詳細指針 (WCAG 適合)
- 課金 / マネタイズ
- 分析用ログの外部蓄積
- ユニーク性重複検証（将来課題）

## 5. 用語定義
| 用語 | 定義 |
|------|------|
| セッション (Session) | start から result 取得までの一連のプレイ単位 |
| シーン (Scene) | 分岐テキスト表示と4つの選択肢セット |
| 選択肢 (Choice) | シーンに提示される行動/回答オプション（常に4） |
| 評価軸 (Axis) | 行動指向性を測る抽象次元（2〜6 個） |
| タイプ (Type) | 主たる2軸の極性組合せより導出される分類ラベル |
| 重みベクトル (Weight Vector) | 各選択肢が各評価軸へ与える加算影響値 |
| 正規化 (Normalization) | 軸スコアを 0〜100 に線形変換する操作 |
| フェイルオーバー | LLM 失敗時の再試行/プリセット切替処理 |
| プリセットタイプ | 失敗時に使用する固定タイプ 6 種 |

## 6. ユースケース概要
### UC-01: 診断プレイ
1. ユーザーがアプリにアクセスし「Start」操作
2. セッション開始 (評価軸生成 + シナリオ初期化)
3. 4 シーンを順番に表示
4. 各シーンでユーザーが1選択肢を選ぶ
5. 内部スコア集計・最終計算
6. タイプ分類・スコア結果表示
7. セッション終了（データ破棄）

### 主要ユーザフロー (単一路線)
start → scene1 → scene2 → scene3 → scene4 → result

## 7. 機能要件 (Functional Requirements)
| ID | 要件 | 説明 | 優先度 |
|----|------|------|--------|
| FR-001 | セッション開始API | 評価軸(2〜6)と初回シーンメタ生成 | High |
| FR-002 | シーン取得API | 指定シーン番号に対応するシナリオ + 4選択肢取得 | High |
| FR-003 | 選択記録 | 各選択で内部スコア加算処理 | High |
| FR-004 | 重みベクトル生成 | 各選択肢に軸重みベクトル付与（AI 生成） | High |
| FR-005 | 評価軸動的生成 | 軸名/説明/重み/方向性決定 | High |
| FR-006 | タイプ分類動的生成 | 軸極性組合せによる 4〜6 タイプ生成 | High |
| FR-007 | タイプ命名制約 | 英語1〜2語, 最大14文字, 重複不可 | High |
| FR-008 | タイプフェイルオーバー | 生成失敗時プリセット6タイプ適用 | High |
| FR-009 | 結果生成API | 正規化スコア + タイプ判定結果返却 | High |
| FR-010 | 正規化処理 | 各軸 0〜100 線形変換 | High |
| FR-011 | 再試行制御 | LLM 失敗時 1 回即時再試行 | High |
| FR-012 | シナリオフェイルオーバー | 再試行失敗時固定シナリオ利用 | High |
| FR-013 | セッション状態管理 | メモリ内 or 一時コンテキスト保持 | Medium |
| FR-014 | 残シーン遷移制御 | 選択確定後 次シーン取得 | High |
| FR-015 | スコア集計 | 重みベクトル逐次加算 | High |
| FR-016 | タイプ極性判定 | 主軸高低閾値で極性 Hi/Lo 算出 | Medium |
| FR-017 | API レイテンシ計測 | p95 計測可能なメトリクス埋め込み | Medium |
| FR-018 | スコア表示UI | 軸スコア + タイプ + 簡易説明表示 | High |
| FR-019 | セッション終了処理 | 結果表示後メモリ破棄 | Medium |
| FR-020 | リクエストバリデーション | 必須パラメータ検証 | High |
| FR-021 | 重複命名検出 | 生成タイプ重複時リネームor再生成 | Medium |
| FR-022 | 軸数範囲保証 | 2〜6 の範囲外生成時リトライ | High |
| FR-023 | 解析ロジック抽象化層 | スコア計算を独立モジュール化 | Medium |
| FR-024 | ログ（最低限） | 障害解析用エラーログ出力（PII 無） | Medium |
| FR-025 | クライアント再取得保護 | result 取得後再度シーン取得不可 | Low |

## 8. 機能外 (Explicit Exclusions)
- 複数同時セッションをユーザー単位で持つ管理
- 過去結果比較
- 詳細レポート (PDF/Export)
- ソーシャルシェア生成画像
- 多言語切替

## 9. シナリオ生成要件
- MVP では 4 シーン × 各 4 選択肢を提示し、高密度・短尺の文面を維持する。
- セッション開始時に統一テーマを決定し、各シーンで一貫したコンテキストを保つ。
- LLM 応答が失敗した場合は固定シナリオへ切り替える。
- 詳細設計: docs/design/overview.md §3.1, §6.2

## 10. 評価軸生成要件
- 軸数は 2〜6 の範囲とし、名称・説明・方向性をセットで提供する。
- 軸の重みは選択肢ごとに配列で返却し、後段で正規化する。
- 範囲外やエラー時は既定 2 軸へフォールバックする。
- 詳細設計: docs/design/overview.md §3.2

## 11. タイプ分類要件
- 正規化スコアに基づき 4〜6 タイプを生成し、名称と短い説明を返す。
- 主軸は分散などの指標から 2 軸を選定し、閾値ベースで極性を判定する。
- 命名は英語 1〜2 語、14 文字以内とし、重複や不適切語を排除する。
- 詳細設計: docs/design/overview.md §3.3, §5, §6.1, §6.3

## 12. スコアリング要件
- 選択肢の重みを累積し、0〜100 に線形正規化する。
- 全軸同値時は一律 50 として Neutral 扱いとする。
- スコアの平均・分散を算出し、タイプ分類の閾値計算に利用する。
- 詳細設計: docs/design/overview.md §3.4

## 13. セッションライフサイクル要件
- セッション開始、シーン取得、選択送信、結果取得、終了の各 API を提供する。
- セッション状態は STATE_INIT → STATE_PLAY → STATE_RESULT → STATE_TERMINATED の順に遷移する。
- 結果取得後の再シーン取得は禁止し、整合性を維持する。
- 詳細設計: docs/design/overview.md §2

## 14. フェイルオーバー要件
- 軸・シナリオ・タイプ生成はそれぞれ 1 回まで自動再試行する。
- 失敗時は既定資材を返却し、原因コードをログに記録する。
- タイムアウト時は即座にフォールバックを適用する。
- 詳細設計: docs/design/overview.md §4, §6

## 15. 非機能要件 (NFR)
### 15.1 Performance
| ID | 要件 | 指標 |
|----|------|------|
| NFR-PERF-001 | シーン生成 p95 | ≤ 800ms |
| NFR-PERF-002 | 結果生成 p95 | ≤ 1.2s |
| NFR-PERF-003 | 全セッション(4シーン+結果) p95 | ≤ 4.5s |
| NFR-PERF-004 | 同時セッション 10 維持 | p95 劣化なし |
### 15.2 Reliability
| ID | 要件 | 指標 |
|----|------|------|
| NFR-REL-001 | フェイルオーバー成功率 | > 99% fallback 実行完了 |
| NFR-REL-002 | LLM 失敗検出 | 100% エラーコード付与 |
### 15.3 UX
| ID | 要件 | 指標 |
|----|------|------|
| NFR-UX-001 | 初回操作→結果まで操作回数最小 | 5 クリック以下 |
| NFR-UX-002 | モバイル表示幅対応 | 360px min |
### 15.4 Security/Privacy
| ID | 要件 | 指標 |
|----|------|------|
| NFR-SEC-001 | 個人情報非取得 | 収集フィールド 0 |
| NFR-SEC-002 | セッション ID 推測困難 | ランダム > 64bit |
### 15.5 Maintainability
| ID | 要件 | 指標 |
|----|------|------|
| NFR-MNT-001 | ロジック分離 | スコア計算独立モジュール化 |
| NFR-MNT-002 | 軸/タイプ生成差し替え容易性 | 実装抽象インタフェース化 |
### 15.6 Extensibility
| ID | 要件 | 指標 |
|----|------|------|
| NFR-EXT-001 | 軸数範囲拡張容易 | 上限変更で追加処理改修 ≤ 1 日 |
| NFR-EXT-002 | 永続化追加容易 | Repository 層追加のみで実現 |

## 16. 性能指標
- p95 シーン生成API: ≤ 800ms
- p95 結果生成API: ≤ 1.2s
- p95 セッション合計 (start→result): ≤ 4.5s
- 同時稼働セッション数: 10（上記 p95 維持）
- タイプ分類ロジック CPU 使用: 単回 < 5ms 目安 (想定)

## 17. 制約 & 前提
| 区分 | 内容 |
|------|------|
| 技術 | LLM 外部 API への依存 |
| データ | 永続化なし / 再現性低い |
| コスト | 推論コール数最小化方針（シーン一括 or バッチ） |
| 法的 | 個人情報非取得前提 |
| インフラ | 単一リージョン運用（冗長化初期非対応） |
| キャッシュ | セッション内のみ有効 |

## 18. リスク & 未決事項
| 項目 | 状態 | 理由/影響 | 暫定対応 |
|------|------|-----------|----------|
| ユニーク性検証 | 未決 | 重複体験による鮮度低下 | 将来拡張で差分判定 |
| 軸方向性閾値 | 未決 | Hi/Lo 判定厳格度不確定 | 平均 ±10pt 暫定 |
| LLM コスト上限 | 未決 | コスト最適化基準なし | 利用ログ計測後決定 |
| バッチ生成方式 | 未決 | 1回or逐次生成比較未評価 | MVP は逐次で簡素化 |
| セッションID 生成方式 | 未決 | UUID / ULID / NanoID 選択 | 一時 UUIDv4 仮採用 |
| 語彙フィルタ | 未決 | 不適切語出力リスク | 初期は LLM Safety 任せ |

## 19. 将来拡張 (Future)
- 履歴永続化 / 再比較
- 重複検知 (近似テキスト距離 / hashing)
- 高次元クラスタリング再分類 (Dynamic Typing)
- 多言語対応 (英語 / 他)
- シーン数可変化
- 選択肢難易度調整
- A/B モデル比較
- アクセシビリティ (ARIA, キーボード操作最適化)
- 可視化強化 (レーダーチャート)
- ソーシャルシェア画像生成
- メタ学習による軸提案品質向上

## 20. トレーサビリティ初期マッピング
| FR | 関連仕様 | 備考 |
|----|----------|------|
| FR-001 | 評価軸生成要件(10), docs/design/overview.md §3.2 | |
| FR-002 | シナリオ生成要件(9), docs/design/overview.md §3.1 | |
| FR-003 | スコアリング要件(12), docs/design/overview.md §3.4 | 解析ロジック抽象化にも連動 |
| FR-004 | シナリオ生成要件(9), スコアリング要件(12), docs/design/overview.md §3.1, §3.4 | |
| FR-005 | 評価軸生成要件(10), docs/design/overview.md §3.2 | |
| FR-006 | タイプ分類要件(11), docs/design/overview.md §3.3 | |
| FR-007 | タイプ分類要件(11), docs/design/overview.md §3.3.6 | 命名規約を参照 |
| FR-008 | タイプ分類要件(11), フェイルオーバー要件(14), docs/design/overview.md §4.2 | |
| FR-009 | スコアリング要件(12), セッションライフサイクル要件(13), docs/design/overview.md §2, §3.4 | |
| FR-010 | スコアリング要件(12), docs/design/overview.md §3.4 | |
| FR-011 | フェイルオーバー要件(14), docs/design/overview.md §4 | |
| FR-012 | フェイルオーバー要件(14), docs/design/overview.md §4 | |
| FR-015 | スコアリング要件(12), docs/design/overview.md §3.4 | |
| FR-016 | タイプ分類要件(11), スコアリング要件(12), docs/design/overview.md §3.3, §3.4 | |
| FR-017 | 性能指標(16) | |
| FR-018 | UI 要件(7), タイプ分類要件(11), docs/design/overview.md §3.3 | |
| FR-022 | 評価軸生成要件(10), docs/design/overview.md §3.2 | |
| FR-LOG-001 | ログとメトリクス(§15, docs/design/overview.md §5.2) | |
| FR-ALG-001 | 動的閾値ロジック(11), docs/design/overview.md §3.3.5 | |

## 21. 関連設計ドキュメント
- アルゴリズムおよびフォールバックの詳細: docs/design/overview.md §3〜§6
- プレースホルダー資材 (プリセットタイプ・固定シナリオ・命名ガイド): docs/design/overview.md §6
